services:

  # ============================================================================
  # 0. LA TOUR DE CONTROLE (TRAEFIK V3)
  # RÃ´le : Reverse Proxy. Point d'entrÃ©e unique sur le port 80.
  # ============================================================================
  traefik:
    image: traefik:v3.1
    container_name: sms_traefik
    command:
      - "--api.insecure=true"        # Dashboard sur 8080
      - "--providers.docker=true"    # Ã‰coute Docker
      - "--providers.docker.exposedbydefault=false" # ğŸ›¡ï¸ SÃ©curitÃ© : ignore les autres containers
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"                      # Port Web public (http://localhost)
      - "8080:8080"                  # Dashboard Traefik
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    networks:
      - sms_network
    restart: unless-stopped

  # ============================================================================
  # 1. LE PASSE-PLAT (BROKER REDIS)
  # RÃ´le : File d'attente pour les tÃ¢ches IA (Broker Taskiq).
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: sms_redis
    networks:
      - sms_network
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # ============================================================================
  # 2. LA MÃ‰MOIRE (BASE DE DONNÃ‰ES) [NOUVEAU V3.1]
  # RÃ´le : Stockage persistant (Utilisateurs, Suivi des Jobs, MÃ©tadonnÃ©es).
  # Image : Postgres 18 Alpine (DerniÃ¨re Stable 2026 - LÃ©gÃ¨re & SÃ©curisÃ©e).
  # ============================================================================
  postgres:
    image: postgres:18-alpine
    container_name: sms_postgres
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: smart_meeting
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d smart_meeting"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - sms_network
    restart: unless-stopped

  # ============================================================================
  # 3. LE GUICHET (API GATEWAY)
  # RÃ´le : FastAPI Gateway (FastAPI 0.128 | Taskiq 0.12).
  # Note : ReÃ§oit les fichiers, les stocke via fsspec et dÃ©lÃ¨gue au Worker.
  # ============================================================================
  api:
    build: 
      context: ./backend-python
    container_name: sms_api
    command: uvicorn app.main:app --host 0.0.0.0 --port 5000 --reload
    
    expose:
      - "5000" # Expose en interne pour Traefik uniquement
    
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sms_api.rule=Host(`localhost`)"
      - "traefik.http.routers.sms_api.entrypoints=web"
      - "traefik.http.services.sms_api.loadbalancer.server.port=5000"
    
    volumes:
      - ./backend-python/app:/code/app
      - ./data_shared:/data
    environment:
      - REDIS_URL=redis://redis:6379
      # Connexion asynchrone Ã  la DB (asyncpg)
      - POSTGRES_URL=postgresql+asyncpg://user:password@postgres:5432/smart_meeting
      - STORAGE_PATH=/data
      - HF_TOKEN=${HF_TOKEN}
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - sms_network
    restart: unless-stopped

  # ============================================================================
  # 4. L'OUVRIER (WORKER IA)
  # RÃ´le : Pipeline IA (Diarisation -> Identification -> Transcription).
  # âœ… ACCÃˆS GPU EXCLUSIF.
  # ============================================================================
  worker:
    build: 
      context: ./backend-python
    container_name: sms_worker
    # Lancement du worker Taskiq avec dÃ©couverte automatique des tÃ¢ches
    command: taskiq worker app.broker:broker --fs-discover --workers 1
    
    volumes:
      - ./backend-python/app:/code/app
      - ./backend-python/voice_bank:/code/voice_bank
      - ./data_shared:/data
    environment:
      - REDIS_URL=redis://redis:6379
      # Le worker doit aussi pouvoir Ã©crire le statut des jobs en DB
      - POSTGRES_URL=postgresql+asyncpg://user:password@postgres:5432/smart_meeting
      - STORAGE_PATH=/data
      - HF_TOKEN=${HF_TOKEN}
    
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    depends_on:
      - redis
      - postgres
    networks:
      - sms_network
    restart: unless-stopped

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RÃ‰SEAUX & VOLUMES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
networks:
  sms_network:
    name: sms_network # Force le nom pour Ã©viter les prÃ©fixes docker
    driver: bridge

volumes:
  redis_data:
  postgres_data: # Persistance des donnÃ©es PostgreSQL