services:
  # --- 1. Reverse Proxy (Traefik) ---
  traefik:
    image: traefik:v3.0
    container_name: traefik
    command:
      - "--api.insecure=true" # Active le dashboard sur le port 8080
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"     # Port HTTP standard
      - "8080:8080" # Dashboard Traefik
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
  # --- 2. Backend IA ---
  backend-python:
    # --- CONSTRUCTION DE L'IMAGE ---
    # On dit à Docker où trouver le Dockerfile pour construire ce service
    build: 
      context: ./backend-python
    
    # Le petit nom du conteneur pour le trouver facilement avec "docker ps"
    container_name: smart-meeting-scribe
    restart: unless-stopped
    env_file:
      - .env

    volumes:
      # On mappe les dossiers locaux pour conserver les données (Recordings & Voice Bank)
      # Attention : Le code s'attend à trouver 'voice_bank' en remontant l'arborescence
      # On va les monter directement dans /code/backend-python si nécessaire ou ajuster les chemins.
      # Pour l'instant, montons-les à la racine du WORKDIR (/code)
      - ./backend-python/recordings:/code/recordings
      - ./backend-python/voice_bank:/code/voice_bank

    # --- LES PERMISSIONS MATÉRIELLES (GPU) ---
    # Cette section est CRITIQUE. Sans elle, le conteneur ne voit pas la RTX 4070 Ti.
    # Docker fait un "Pass-through" du driver NVIDIA de Windows vers Linux.
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1             # Utilise 1 GPU (le premier disponible)
              capabilities: [gpu]  # Active les capacités de calcul CUDA

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=Host(`localhost`) || PathPrefix(`/api`)"
      - "traefik.http.services.backend.loadbalancer.server.port=8000"